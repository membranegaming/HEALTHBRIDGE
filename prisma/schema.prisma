// HealthBridge - Hospital Management System Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================== ENUMS =====================

enum UserRole {
  PATIENT
  DOCTOR
  ADMIN
  RECEPTIONIST
  NURSE
  PHARMACIST
  BILLING_STAFF
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AppointmentStatus {
  SCHEDULED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum TokenStatus {
  WAITING
  CALLED
  IN_CONSULTATION
  COMPLETED
  SKIPPED
}

enum TokenPriority {
  NORMAL
  PRIORITY
  EMERGENCY
}

enum PaymentStatus {
  PENDING
  PARTIAL
  COMPLETED
  REFUNDED
  FAILED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  NET_BANKING
  WALLET
  INSURANCE
}

enum ClaimStatus {
  DRAFT
  SUBMITTED
  PRE_AUTHORIZED
  APPROVED
  REJECTED
  SETTLED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  READY
  DISPATCHED
  DELIVERED
  CANCELLED
}

enum ConsentType {
  GENERAL
  SURGERY
  ANESTHESIA
  BLOOD_TRANSFUSION
  HIGH_RISK_PROCEDURE
}

// ===================== USER & AUTH =====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  phone         String?   @unique
  password      String
  name          String
  role          UserRole
  avatar        String?
  isActive      Boolean   @default(true)
  emailVerified DateTime?
  phoneVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  patient       Patient?
  doctor        Doctor?
  staff         Staff?
  sessions      Session[]
  notifications Notification[]
  auditLogs     AuditLog[]

  @@index([email])
  @@index([phone])
  @@index([role])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ===================== PATIENT =====================

model Patient {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Info
  dateOfBirth     DateTime?
  gender          Gender?
  bloodGroup      String?
  height          Float?    // in cm
  weight          Float?    // in kg
  
  // Address
  address         String?
  city            String?
  state           String?
  pincode         String?
  
  // Emergency Contact
  emergencyName   String?
  emergencyPhone  String?
  emergencyRelation String?
  
  // Medical Info
  allergies       String[]
  chronicConditions String[]
  
  // Insurance
  insurancePolicyNo String?
  insuranceProvider String?
  insuranceExpiry   DateTime?
  
  // ID Verification
  aadhaarNumber   String?
  abhaId          String?   // ABDM Health ID
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  appointments    Appointment[]
  tokens          Token[]
  prescriptions   Prescription[]
  medicalRecords  MedicalRecord[]
  labReports      LabReport[]
  bills           Bill[]
  insuranceClaims InsuranceClaim[]
  consents        Consent[]
  medicineOrders  MedicineOrder[]
  dependents      Patient[] @relation("PatientDependents")
  guardian        Patient?  @relation("PatientDependents", fields: [guardianId], references: [id])
  guardianId      String?

  @@index([userId])
}

// ===================== DOCTOR =====================

model Doctor {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Professional Info
  registrationNo    String   @unique
  specialization    String
  qualification     String[]
  experience        Int      // years
  
  // Department
  departmentId      String?
  department        Department? @relation(fields: [departmentId], references: [id])
  
  // Consultation
  consultationFee   Float
  followUpFee       Float
  slotDurationMins  Int      @default(15)
  
  // Availability
  isAvailable       Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  schedules         DoctorSchedule[]
  appointments      Appointment[]
  consultations     Consultation[]
  prescriptions     Prescription[]
  leaveRequests     LeaveRequest[]
  prescriptionTemplates PrescriptionTemplate[]

  @@index([userId])
  @@index([specialization])
  @@index([departmentId])
}

model DoctorSchedule {
  id          String   @id @default(cuid())
  doctorId    String
  doctor      Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  dayOfWeek   Int      // 0-6 (Sunday-Saturday)
  startTime   String   // HH:mm format
  endTime     String   // HH:mm format
  maxPatients Int      @default(20)
  isActive    Boolean  @default(true)

  @@unique([doctorId, dayOfWeek])
  @@index([doctorId])
}

model LeaveRequest {
  id          String   @id @default(cuid())
  doctorId    String
  doctor      Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  startDate   DateTime
  endDate     DateTime
  reason      String?
  isApproved  Boolean  @default(false)
  approvedBy  String?
  
  createdAt   DateTime @default(now())

  @@index([doctorId])
}

// ===================== STAFF =====================

model Staff {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  employeeId    String   @unique
  designation   String
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])
  
  joiningDate   DateTime
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([departmentId])
}

// ===================== DEPARTMENT =====================

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  floor       String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  doctors     Doctor[]
  staff       Staff[]
}

// ===================== APPOINTMENTS & TOKENS =====================

model Appointment {
  id            String            @id @default(cuid())
  patientId     String
  patient       Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctorId      String
  doctor        Doctor            @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  scheduledDate DateTime
  scheduledTime String            // HH:mm format
  duration      Int               @default(15) // minutes
  
  type          String            @default("CONSULTATION") // CONSULTATION, FOLLOW_UP, TELEMEDICINE
  status        AppointmentStatus @default(SCHEDULED)
  
  symptoms      String?
  notes         String?
  
  isWalkIn      Boolean           @default(false)
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relations
  token         Token?
  consultation  Consultation?
  bill          Bill?

  @@index([patientId])
  @@index([doctorId])
  @@index([scheduledDate])
  @@index([status])
}

model Token {
  id            String        @id @default(cuid())
  tokenNumber   Int
  patientId     String
  patient       Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointmentId String?       @unique
  appointment   Appointment?  @relation(fields: [appointmentId], references: [id])
  
  date          DateTime      @default(now())
  status        TokenStatus   @default(WAITING)
  priority      TokenPriority @default(NORMAL)
  
  queuePosition Int?
  estimatedWait Int?          // minutes
  
  calledAt      DateTime?
  completedAt   DateTime?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([tokenNumber, date])
  @@index([patientId])
  @@index([date])
  @@index([status])
}

// ===================== CONSULTATION & PRESCRIPTION =====================

model Consultation {
  id            String      @id @default(cuid())
  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  doctorId      String
  doctor        Doctor      @relation(fields: [doctorId], references: [id])
  
  chiefComplaint String?
  symptoms       String[]
  diagnosis      String?
  clinicalNotes  String?
  
  vitals         Json?       // BP, temp, pulse, SpO2, etc.
  
  followUpDate   DateTime?
  
  startTime      DateTime    @default(now())
  endTime        DateTime?
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  prescription   Prescription?
  labOrders      LabOrder[]

  @@index([doctorId])
}

model Prescription {
  id              String       @id @default(cuid())
  consultationId  String?      @unique
  consultation    Consultation? @relation(fields: [consultationId], references: [id])
  patientId       String
  patient         Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctorId        String
  doctor          Doctor       @relation(fields: [doctorId], references: [id])
  
  diagnosis       String?
  instructions    String?
  
  validUntil      DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  medicines       PrescriptionMedicine[]
  medicineOrders  MedicineOrder[]

  @@index([patientId])
  @@index([doctorId])
}

model PrescriptionMedicine {
  id              String       @id @default(cuid())
  prescriptionId  String
  prescription    Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  
  medicineName    String
  dosage          String       // e.g., "500mg"
  frequency       String       // e.g., "Twice daily"
  duration        String       // e.g., "7 days"
  timing          String?      // e.g., "After meals"
  quantity        Int?
  instructions    String?

  @@index([prescriptionId])
}

model PrescriptionTemplate {
  id          String   @id @default(cuid())
  doctorId    String
  doctor      Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  name        String
  diagnosis   String?
  medicines   Json     // Array of medicine objects
  instructions String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([doctorId])
}

// ===================== MEDICINE ORDERS =====================

model MedicineOrder {
  id              String       @id @default(cuid())
  patientId       String
  patient         Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  prescriptionId  String?
  prescription    Prescription? @relation(fields: [prescriptionId], references: [id])
  
  status          OrderStatus  @default(PENDING)
  totalAmount     Float
  
  deliveryAddress String?
  deliveryNotes   String?
  
  orderedAt       DateTime     @default(now())
  deliveredAt     DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  items           MedicineOrderItem[]
  payment         Payment?

  @@index([patientId])
  @@index([status])
}

model MedicineOrderItem {
  id          String        @id @default(cuid())
  orderId     String
  order       MedicineOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  medicineName String
  quantity    Int
  unitPrice   Float
  totalPrice  Float

  @@index([orderId])
}

model MedicineReminder {
  id            String   @id @default(cuid())
  patientId     String
  medicineName  String
  dosage        String
  frequency     String
  timings       String[] // Array of times like ["08:00", "20:00"]
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([patientId])
}

// ===================== LAB & MEDICAL RECORDS =====================

model LabOrder {
  id              String       @id @default(cuid())
  consultationId  String
  consultation    Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  
  testName        String
  instructions    String?
  priority        String       @default("NORMAL")
  status          String       @default("ORDERED") // ORDERED, SAMPLE_COLLECTED, PROCESSING, COMPLETED
  
  orderedAt       DateTime     @default(now())
  completedAt     DateTime?

  report          LabReport?

  @@index([consultationId])
}

model LabReport {
  id          String    @id @default(cuid())
  patientId   String
  patient     Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  labOrderId  String?   @unique
  labOrder    LabOrder? @relation(fields: [labOrderId], references: [id])
  
  testName    String
  result      Json?
  findings    String?
  reportUrl   String?
  
  testedAt    DateTime?
  reportedAt  DateTime  @default(now())

  @@index([patientId])
}

model MedicalRecord {
  id          String   @id @default(cuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  recordType  String   // PRESCRIPTION, LAB_REPORT, SCAN, DISCHARGE_SUMMARY, etc.
  title       String
  description String?
  fileUrl     String?
  
  recordDate  DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([patientId])
  @@index([recordType])
}

// ===================== BILLING & PAYMENTS =====================

model Bill {
  id            String        @id @default(cuid())
  billNumber    String        @unique
  patientId     String
  patient       Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointmentId String?       @unique
  appointment   Appointment?  @relation(fields: [appointmentId], references: [id])
  
  subtotal      Float
  tax           Float         @default(0)
  discount      Float         @default(0)
  totalAmount   Float
  paidAmount    Float         @default(0)
  
  status        PaymentStatus @default(PENDING)
  dueDate       DateTime?
  
  notes         String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  items         BillItem[]
  payments      Payment[]
  insuranceClaim InsuranceClaim?

  @@index([patientId])
  @@index([status])
}

model BillItem {
  id          String @id @default(cuid())
  billId      String
  bill        Bill   @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  description String
  category    String // CONSULTATION, PROCEDURE, MEDICINE, ROOM, LAB, etc.
  quantity    Int    @default(1)
  unitPrice   Float
  totalPrice  Float

  @@index([billId])
}

model Payment {
  id            String        @id @default(cuid())
  billId        String?
  bill          Bill?         @relation(fields: [billId], references: [id])
  orderId       String?       @unique
  order         MedicineOrder? @relation(fields: [orderId], references: [id])
  
  amount        Float
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  
  transactionId String?
  receiptUrl    String?
  
  paidAt        DateTime?
  createdAt     DateTime      @default(now())

  @@index([billId])
}

// ===================== INSURANCE =====================

model InsuranceClaim {
  id              String      @id @default(cuid())
  patientId       String
  patient         Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  billId          String      @unique
  bill            Bill        @relation(fields: [billId], references: [id])
  
  policyNumber    String
  insuranceProvider String
  
  claimAmount     Float
  approvedAmount  Float?
  
  status          ClaimStatus @default(DRAFT)
  
  preAuthRequired Boolean     @default(false)
  preAuthNumber   String?
  
  submittedAt     DateTime?
  approvedAt      DateTime?
  rejectionReason String?
  
  documents       String[]    // URLs to uploaded documents
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([patientId])
  @@index([status])
}

// ===================== CONSENT =====================

model Consent {
  id            String      @id @default(cuid())
  patientId     String
  patient       Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  type          ConsentType
  procedureName String
  description   String
  risks         String[]
  
  // Patient Signature
  patientSignature    String?
  patientSignedAt     DateTime?
  patientAadhaarOtp   Boolean   @default(false)
  
  // Guardian Signature (if applicable)
  guardianName        String?
  guardianRelation    String?
  guardianSignature   String?
  guardianSignedAt    DateTime?
  guardianAadhaarOtp  Boolean   @default(false)
  
  // Witness
  witnessName         String?
  witnessSignature    String?
  
  isValid       Boolean     @default(false)
  expiresAt     DateTime?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([patientId])
  @@index([type])
}

// ===================== NOTIFICATIONS =====================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title     String
  message   String
  type      String   // APPOINTMENT, PRESCRIPTION, PAYMENT, REMINDER, etc.
  data      Json?
  
  isRead    Boolean  @default(false)
  readAt    DateTime?
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

// ===================== AUDIT & LOGS =====================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  action      String
  entityType  String
  entityId    String?
  oldValue    Json?
  newValue    Json?
  
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

// ===================== INVENTORY (Pharmacy) =====================

model Medicine {
  id            String   @id @default(cuid())
  name          String
  genericName   String?
  manufacturer  String?
  category      String?
  
  unitPrice     Float
  stockQuantity Int      @default(0)
  reorderLevel  Int      @default(10)
  
  expiryDate    DateTime?
  batchNumber   String?
  
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([name])
  @@index([category])
}

// ===================== AMBULANCE =====================

model AmbulanceRequest {
  id            String   @id @default(cuid())
  patientId     String?
  patientName   String
  patientPhone  String
  
  pickupAddress String
  pickupLat     Float?
  pickupLng     Float?
  
  status        String   @default("REQUESTED") // REQUESTED, DISPATCHED, EN_ROUTE, ARRIVED, COMPLETED
  priority      String   @default("NORMAL")
  
  ambulanceId   String?
  driverName    String?
  driverPhone   String?
  
  requestedAt   DateTime @default(now())
  dispatchedAt  DateTime?
  arrivedAt     DateTime?
  completedAt   DateTime?

  @@index([status])
}

// ===================== VISITOR MANAGEMENT =====================

model VisitorPass {
  id            String   @id @default(cuid())
  visitorName   String
  visitorPhone  String
  
  patientId     String
  patientName   String
  wardNumber    String?
  
  passCode      String   @unique
  validFrom     DateTime
  validUntil    DateTime
  
  checkedInAt   DateTime?
  checkedOutAt  DateTime?
  
  createdAt     DateTime @default(now())

  @@index([patientId])
  @@index([passCode])
}
